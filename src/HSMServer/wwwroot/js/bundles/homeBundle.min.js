function getMimeType(fileName){let extension=getExtensionFromName(fileName),fileType=mimeTypesMap.get(extension);return fileType===undefined&&(fileType="text/html"),fileType}function getExtensionFromName(fileName){let dotIndex=fileName.indexOf(".");return dotIndex===-1?fileName:fileName.substring(dotIndex+1,fileName.length)}function openFileInBrowser(path,fileName,viewFileAction){let fileType=getMimeType(fileName);$("#spinner").css("display","block");$("#mainContainer").css("display","none");$("#navbar").css("display","none");$.ajax({type:"POST",url:viewFileAction+"?Selected="+path,cache:!1,contentType:"application/json",success:function(response){fileType===undefined&&(fileType="text/html");let blob=new Blob([response],{type:fileType}),url=window.URL.createObjectURL(blob);window.open(url);$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")},error:function(){console.log("Failed to load file!");$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")}})}function Data(to,from,type,path){return{To:to,From:from,Type:type,Path:path}}function deleteSensor(){let path=this.id.substring(21);$.ajax({type:"POST",url:removeSensorAction+"?Selected="+path,contentType:"application/json",dataType:"html",cache:!1,async:!0})}function displayList(data){$('[id^="list_"]').css("display","none");$('[id^="sensorData_"]').css("display","none");$("#noData").css("display","none");hideSensorInfoParentBlocks();let id=data.node==undefined?data.id:data.node.id;if(id.startsWith("sensor_")){let path=id.substring(7),dataElement=$("#sensorData_"+path)[0];$("#sensorData_"+path).css("display","block");$("#sensorInfo_parent_"+path).css("display","block");let parent=data.node==undefined?data.parent:data.node.parent;$("#list_"+parent).css("display","block");$("#"+path).attr("aria-expanded")=="false"&&$("#"+path).click()}else{hideSensorInfoParentBlocks();let path=id,listId="#list_"+path;$(listId).css("display","block");showAllChildAccordionsById(listId)}}function showAllChildAccordionsById(id){let element=$(id)[0];if(element!=undefined){let children=element.childNodes;children.forEach(ch=>{ch.classList.contains("accordion")&&(ch.style.display="block")})}}function hideSensorInfoParentBlocks(){$('[id^="sensorInfo_parent_"]').css("display","none")}function displayGraph(graphData,graphType,graphElementId,graphName){let convertedData=convertToGraphData(graphData,graphType,graphName),zoomData=getPreviousZoomData(graphElementId);if(zoomData===undefined||zoomData===null)Plotly.newPlot(graphElementId,convertedData);else{let layout=createLayoutFromZoomData(zoomData);Plotly.newPlot(graphElementId,convertedData,layout)}let graphDiv=document.getElementById(graphElementId);graphDiv.on("plotly_relayout",function(eventData){window.sessionStorage.setItem(graphElementId,JSON.stringify(eventData))})}function createLayoutFromZoomData(zoomData){let processedData=Object.values(JSON.parse(zoomData));return{xaxis:{range:[processedData[0],processedData[1]]},yaxis:{range:[processedData[2],processedData[3]]}}}function getPreviousZoomData(graphElementId){return window.sessionStorage.getItem(graphElementId)}function convertToGraphData(graphData,graphType,graphName){let escapedData=JSON.parse(graphData),data,deserialized,timeList;switch(graphType){case"0":return data=getBoolData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"bar");case"1":return data=getIntegersData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"2":return data=getDoublesData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"4":return deserialized=getDeserializedBarsData(escapedData),createBarGraphData(deserialized,graphName);case"5":return deserialized=getDeserializedBarsData(escapedData),createBarGraphData(deserialized,graphName);default:return undefined}}function getPlotType(graphType){return graphType===1||graphType===2?"scatter":graphType===4||graphType===5?"box":undefined}function initializeInfoLinks(){$('[id^="sensorInfo_link_"]').off("click").on("click",metaInfoLinkClicked)}function metaInfoLinkClicked(){let path=this.id.substring(16);$("#sensor_info_"+path).is(":empty")?showMetaInfo(path):hideMetaInfo(path)}function showMetaInfo(path){$.ajax({type:"GET",url:getSensorInfoAction+"?Path="+path,dataType:"html",contentType:"application/json",cache:!1,async:!0}).done(function(data){$("#sensor_info_"+path).empty().append(JSON.parse(data).value);setLinkText(path,"Hide meta info");initializeEditInfoButtons(path)})}function hideMetaInfo(path){$("#sensor_info_"+path).empty();setLinkText(path,"Show meta info")}function setLinkText(path,text){let link=document.getElementById("sensorInfo_link_"+path);link.textContent=text}function initializeEditInfoButtons(path){$("#editInfo_"+path).on("click",editInfoButtonClick);$("#revertInfo_"+path).on("click",revertInfoClick);$("#saveInfo_"+path).on("click",saveInfoClick)}function editInfoButtonClick(){let path=this.id.substring(9);$("#interval_"+path).removeAttr("disabled");$("#description_"+path).removeAttr("disabled");$("#unit_"+path).removeAttr("disabled");$("#saveInfo_"+path).removeAttr("disabled");$("#revertInfo_"+path).removeAttr("disabled")}function revertInfoClick(){let path=this.id.substring(11);reloadInfo(path)}function saveInfoClick(){let path=this.id.substring(9),description=getDescription(path),interval=getInterval(path),unit=getUnit(path),body=Info(description,interval,path,unit);saveSensorInfo(body)}function saveSensorInfo(body){$.ajax({type:"POST",data:JSON.stringify(body),url:updateSensorInfoAction,contentType:"application/json",dataType:"html",cache:!1,async:!0}).done(function(){reloadInfo(body.EncodedPath)})}function Info(description,updatePeriod,encodedPath,unit){return{Description:description,ExpectedUpdateInterval:updatePeriod,EncodedPath:encodedPath,Unit:unit}}function getDescription(path){return $("#description_"+path).val()}function getInterval(path){return $("#interval_"+path).val()}function getUnit(path){return $("#unit_"+path).val()}function reloadInfo(path){let link=document.getElementById("sensorInfo_link_"+path);link.click();link.click()}function initializeTree(){$("#jstree").jstree({core:{check_callback:!0,themes:{name:"proton",responsive:!0}},contextmenu:{items:function($node){var tree=$("#jstree").jstree(!0);return{Delete:{separator_before:!1,separator_after:!1,label:"Delete",action:function(){$("#modalDeleteLabel").empty();$("#modalDeleteLabel").append("Remove node");$("#modalDeleteBody").empty();$("#modalDeleteBody").append('Do you really want to remove "'+$node.text+'" node?');var modal=new bootstrap.Modal(document.getElementById("modalDelete"));modal.show();$("#confirmDeleteButton").on("click",function(){modal.hide();$.ajax({type:"POST",url:removeNode+"?Selected="+$node.id,dataType:"html",contentType:"application/json",cache:!1,async:!0}).done(function(){tree.delete_node($node.id);$("#list_"+$node.id).remove();$("#noData").css("display","block");$('[id^="list_"][style*="display: block;"]').each(function(){this.remove()})})});$("#closeDeleteButton").on("click",function(){modal.hide()})}}}}},plugins:["state","contextmenu","themes","wholerow"]});$("#updateTime").empty();$("#updateTime").append("Update Time: "+(new Date).toUTCString());initializeClickTree()}function initializeClickTree(){$("#jstree").on("activate_node.jstree",function(e,data){data!=undefined&&data.node!=undefined&&data.node.id!=undefined&&displayList(data)})}const mimeTypesMap=new Map;mimeTypesMap.set("html","text/html");mimeTypesMap.set("pdf","application/pdf");var millisecondsInHour=36e5,millisecondsInDay=millisecondsInHour*24;Date.prototype.AddDays=function(days){let date=new Date(this.valueOf());return date.setDate(date.getDate()+days),date};Date.prototype.AddHours=function(hours){let newDate=new Date(this.valueOf());return newDate.setHours(newDate.getHours()+hours),newDate};{function initializeDataHistoryRequests(){$('[id^="collapse"]').off("show.bs.collapse").on("show.bs.collapse",accordionClicked);InitializePeriodRequests();initializeTabLinksRequests();$('[id^="button_view_"]').off("click",viewFile);$('[id^="button_view_"]').on("click",viewFile);$('[id^="button_download_"]').off("click",downloadFile);$('[id^="button_download_"]').on("click",downloadFile)}function downloadFile(){let path=this.id.substring(16);window.location.href=getFileAction+"?Selected="+path}function viewFile(){let path=this.id.substring(12),fileType=document.getElementById("fileType_"+path).value;openFileInBrowser(path,fileType,viewFileAction)}function accordionClicked(){let path=this.id.substring(9),type=getTypeForSensor(path),from=new Date;isFileSensor(type)||(isGraphAvailable(type)?initializeGraph(path,rawHistoryLatestAction,type,Data(from,from,type,path),!0):initializeTable(path,historyLatestAction,type,Data(from,from,type,path),!0))}function initializeTabLinksRequests(){$('[id^="link_graph_"]').off("click").on("click",requestGraph);$('[id^="link_table_"]').off("click").on("click",requestTable)}function requestGraph(){let path=this.id.substring(11),type=getTypeForSensor(path);const{from,to}=getFromAndTo(path);let body=Data(to,from,type,path),action=isAllHistorySelected(path)?rawHistoryAllAction:rawHistoryAction;initializeGraph(path,action,type,body,!1)}function requestTable(){let path=this.id.substring(11),type=getTypeForSensor(path);const{from,to}=getFromAndTo(path);let body=Data(to,from,type,path),action=isAllHistorySelected(path)?historyAllAction:historyAction;initializeTable(path,action,type,body,!1)}function InitializePeriodRequests(){$('[id^="radio_hour_"]').off("click").on("click",requestHistoryHour);$('[id^="radio_day_"]').off("click").on("click",requestHistoryDay);$('[id^="radio_three_days_"]').off("click").on("click",requestHistoryThreeDays);$('[id^="radio_week_"]').off("click").on("click",requestHistoryWeek);$('[id^="radio_month_"]').off("click").on("click",requestHistoryMonth);$('[id^="radio_all_"]').off("click").on("click",requestHistoryAll);$('[id^="button_export_csv_"]').off("click").on("click",exportCsv);$('[id^="button_delete_sensor_"]').off("click").on("click",deleteSensor)}function requestHistoryHour(){let path=this.id.substring(11),type=getTypeForSensor(path);const to=new Date,from=to.AddHours(-1);requestHistory(path,historyAction,rawHistoryAction,type,Data(to,from,type,path))}function requestHistoryDay(){let path=this.id.substring(10),type=getTypeForSensor(path);const to=new Date,from=to.AddDays(-1);requestHistory(path,historyAction,rawHistoryAction,type,Data(to,from,type,path))}function requestHistoryThreeDays(){let path=this.id.substring(17),type=getTypeForSensor(path);const to=new Date,from=to.AddDays(-3);requestHistory(path,historyAction,rawHistoryAction,type,Data(to,from,type,path))}function requestHistoryWeek(){let path=this.id.substring(11),type=getTypeForSensor(path);const to=new Date,from=to.AddDays(-7);requestHistory(path,historyAction,rawHistoryAction,type,Data(to,from,type,path))}function requestHistoryMonth(){let path=this.id.substring(12),type=getTypeForSensor(path);const to=new Date,from=to.AddDays(-30);requestHistory(path,historyAction,rawHistoryAction,type,Data(to,from,type,path))}function requestHistoryAll(){let path=this.id.substring(10),type=getTypeForSensor(path);requestHistory(path,historyAllAction,rawHistoryAllAction,type,{})}}{function requestHistory(path,action,rawAction,type,reqData){if(!isGraphAvailable(type)){initializeTable(path,action,type,reqData,!1);return}isTableHistorySelected(path)?initializeTable(path,action,type,reqData,!1):initializeGraph(path,rawAction,type,reqData,!1)}function exportCsv(){let path=this.id.substring(18),type=getTypeForSensor(path);if(isAllHistorySelected(path)){window.location.href=exportHistoryAllAction+"?Path="+path+"&Type="+type;return}const{from,to}=getFromAndTo(path);window.location.href=exportHistoryAction+"?Path="+path+"&Type="+type+"&From="+from.toISOString()+"&To="+to.toISOString()}function initializeTable(path,tableAction,type,body,needSetRadio){$.ajax({type:"POST",data:JSON.stringify(body),url:tableAction+"?Path="+path+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,async:!0}).done(function(data){$(`#values_${path}`).empty();let values=JSON.parse(data).value;if(values===""){$("#history_"+path).hide();$("#no_data_"+path).show();return}$("#history_"+path).show();$("#no_data_"+path).hide();$(`#values_${path}`).append(values);needSetRadio&&selectRadioForTable(path)})}function initializeGraph(path,rawHistoryAction,type,body,needSetRadio){$.ajax({type:"POST",data:JSON.stringify(body),url:rawHistoryAction+"?Path="+path+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,async:!0}).done(function(data){if(JSON.parse(data).length===0){$("#history_"+path).hide();$("#no_data_"+path).show();return}$("#history_"+path).show();$("#no_data_"+path).hide();let graphDivId="graph_"+path;needSetRadio&&selectAppropriateRadio(data,path);displayGraph(data,type,graphDivId,path)})}}{function selectRadioForTable(path){let currentDate=new Date(Date.parse((new Date).toUTCString())),oldestDate=getOldestDateFromTable(path),difference=currentDate-oldestDate;selectRadioViaDifference(difference,path)}function getOldestDateFromTable(path){let val=$("#oldest_date_"+path).val();return new Date(Date.parse(val))}function selectAppropriateRadio(data,path){let parsedData=JSON.parse(data),currentDate=new Date(Date.parse((new Date).toUTCString())),firstDate=new Date(Date.parse(parsedData[0].time)),difference=currentDate-firstDate;selectRadioViaDifference(difference,path)}function selectRadioViaDifference(difference,path){if(difference<=millisecondsInHour){$("#radio_hour_"+path).prop("checked",!0);return}if(difference<=millisecondsInDay){$("#radio_day_"+path).prop("checked",!0);return}if(difference<=3*millisecondsInDay){$("#radio_three_days_"+path).prop("checked",!0);return}if(difference<=7*millisecondsInDay){$("#radio_week_"+path).prop("checked",!0);return}if(difference<=30*millisecondsInDay){$("#radio_month_"+path).prop("checked",!0);return}$("#radio_all_"+path).prop("checked",!0)}function isFileSensor(type){return type==="6"||type==="7"}function isGraphAvailable(type){return!(type==="3"||type==="6"||type==="7")}function isTableHistorySelected(path){let el=$("#values_parent_"+path);return el.hasClass("show")}function isAllHistorySelected(path){return $("#radio_all_"+path).is(":checked")}function getFromAndTo(path){let from=null,to=null;return $("#radio_hour_"+path).is(":checked")&&(to=new Date,from=to.AddHours(-1)),$("#radio_day_"+path).is(":checked")&&(to=new Date,from=to.AddDays(-1)),$("#radio_three_days_"+path).is(":checked")&&(to=new Date,from=to.AddDays(-3)),$("#radio_week_"+path).is(":checked")&&(to=new Date,from=to.AddDays(-7)),$("#radio_month_"+path).is(":checked")&&(to=new Date,from=to.AddDays(-30)),{from,to}}function getCountForId(id){let inputCount=$("#inputCount_"+id).val();return inputCount===undefined&&(inputCount=10),inputCount}function getTypeForSensor(name){return $("#sensor_type_"+name).val()}}{function getBoolData(escapedItems){return escapedItems.map(function(i){let currentBoolean=JSON.parse(i.typedData).BoolValue===!0;return currentBoolean?1:0})}}{function getSimpleGraphData(timeList,dataList,chartType){return[{x:timeList,y:dataList,type:chartType}]}function getIntegersData(escapedItems){return escapedItems.map(function(i){return JSON.parse(i.typedData).IntValue})}function getDoublesData(escapedItems){return escapedItems.map(function(i){return JSON.parse(i.typedData).DoubleValue})}function getTimeList(escapedItems){return escapedItems.map(function(i){return i.time})}}{function getDeserializedBarsData(escapedItems){return escapedItems.map(function(i){return JSON.parse(i.typedData)})}function getTimeFromBars(escapedBarsData){return escapedBarsData.map(function(d){return d.EndTime.startsWith("0001")?d.StartTime:d.EndTime})}function createBarGraphData(escapedBarsData,graphName){let max=getBarsMax(escapedBarsData),min=getBarsMin(escapedBarsData),median=getBarsMedian(escapedBarsData),q1=getBarsQ1(escapedBarsData),q3=getBarsQ3(escapedBarsData),mean=getBarsMean(escapedBarsData),timeList=getTimeFromBars(escapedBarsData);return[{type:"box",name:graphName,q1:q1,median:median,q3:q3,mean:mean,lowerfence:min,upperfence:max,x:timeList}]}{function getBarsMin(escapedBarsData){return escapedBarsData.map(function(d){return d.Min})}function getBarsMax(escapedBarsData){return escapedBarsData.map(function(d){return d.Max})}function getBarsMedian(escapedBarsData){let medians=[];return escapedBarsData.map(function(d){d.Percentiles.filter(p=>p.Percentile===.5).map(function(p){medians.push(p.Value)})}),medians}function getBarsQ1(escapedBarsData){let q1s=[];return escapedBarsData.map(function(d){d.Percentiles.filter(p=>p.Percentile===.25).map(function(p){q1s.push(p.Value)})}),q1s}function getBarsQ3(escapedBarsData){let q3s=[];return escapedBarsData.map(function(d){d.Percentiles.filter(p=>p.Percentile===.75).map(function(p){q3s.push(p.Value)})}),q3s}function getBarsMean(escapedBarsData){return escapedBarsData.map(function(d){return d.Mean})}}}