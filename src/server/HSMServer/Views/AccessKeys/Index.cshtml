@using HSMServer.Model.AccessKeysViewModels
@using HSMServer.Constants
@using HSMServer.Controllers
@using HSMServer.Core.Helpers
@using HSMServer.Core.Model.Authentication

@model List<AccessKeyViewModel>

@{
    ViewData["Title"] = "Access keys";
}


<script>
    var getAvailableAccessKeys = "@Html.Raw(Url.Action(nameof(AccessKeysController.AvailableAccessKeys), ViewConstants.AccessKeysController))";
    var getSearchKeyResult = "@Html.Raw(Url.Action(nameof(AccessKeysController.SearchKeyResult), ViewConstants.AccessKeysController))";
</script>

<link rel="stylesheet" href="~/css/bundles/accessKeyBundle.min.css"/>
<script src="~/js/clipboard.js/clipboard.min.js"></script>


<div class="container">
    <div class="row justify-content-center">
        <div class="d-flex my-3">
            <div class="col-2 mt-1">
                <h5>Access keys</h5>
            </div>

        </div>
        <div class="row ms-0 ps-0">
            <div class="col-3 mb-1 ms-0 ps-0">
                <input id="searchKey" type="text" class="form-control" placeholder="Filter by key"/>
            </div>
            <div class="col-5 mb-1 ms-1">
                <button type="button" class="btn btn-secondary">
                    <i onclick="searchKey()" type="button" class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <table class="table">
            <tr>
                <th scope="col" id="accessKeys_productColumn">
                    Product
                    @* <br />
                    (
                    <input class="form-check-input" type="checkbox" value="" onchange="allProductsChanged()" id="allProducts">
                    <label class="form-check-label" for="allProducts">
                        node)
                    </label>*@
                </th>
                <th scope="col">Name</th>
                <th scope="col" style="padding: 0;">Key</th>
                <th scope="col" class="text-center">Permissions</th>
                <th scope="col">Author</th>
                <th scope="col" class="text-center">State</th>
                @if (UserRoleHelper.IsManager(User as User))
                {
                    <th scope="col" class="text-center">Actions</th>
                }
                <th ></th>
            </tr>
            <tbody id="accessKeysTable">
            @await Html.PartialAsync("_AllAccessKeys", Model)
            </tbody>
        </table>
    </div>
</div>

@await Html.PartialAsync("_AccessKeysModal")


<script>
    var clipboard = new ClipboardJS('[id^="copy_"]');

    // there is code, that need to call allProductsChanged after closing accessKeys_modal (if there is exist checkbox with id=allProducts)
    $('#accessKeys_modal').on('hidden.bs.modal', function (e) {
        allProductsChanged();
    });

    function allProductsChanged() {
        //let element = document.getElementById('allProducts');
        //let isAllProducts = element.checked;

        let isAllProducts = false;  // false while checkbox id=allProducts is not visible (AccessKeys/Index.cshtml)
        $.ajax({
            type: 'GET',
            url: getAvailableAccessKeys + "?AllProducts=" + isAllProducts,
            cache: false,
            async: true,
            success: function (viewData) {
                $('#accessKeysTable').html(viewData);
            }
        });
    }
    
    function searchKey() {
        const keyToSearch = document.getElementById("searchKey").value;
        $.ajax({
                    type: 'GET',
                    url: getSearchKeyResult + "?SearchKey=" + keyToSearch,
                    cache: false,
                    async: true,
                    success: function (viewData) {
                        $('#accessKeysTable').html(viewData);
                    }
                });
    }
</script>