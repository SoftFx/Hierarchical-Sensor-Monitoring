@using HSMServer.Model.DataAlerts
@using HSMServer.Constants
@using HSMServer.Controllers

@model HSMServer.Model.ViewModel.NodeInfoBaseViewModel

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers


<label class="col-form-label fw-bold">Alerts:</label>

<div class="d-flex ms-3 text-nowrap align-self-center">
    <span class="d-flex align-items-center" style="min-width: 18rem">
       Time to sensor(s) live <i class='fas fa-question-circle ps-1' title='Time format: dd.hh:mm:ss min value 00:01:00. If the sensor doesn`t receive new data within the specified time interval, a notification sends'></i>
    </span>
    <div class="pb-0" style="width: 17rem;">
        <label id="labelInterval" class="col-form-label py-0">@Model.ExpectedUpdateInterval.DisplayInterval</label>
        <div id="partialIntervalSelect" class="d-none">
            <partial name="_TimeIntervalSelect" for="ExpectedUpdateInterval"/>
        </div>
    </div>
    <span class="d-flex align-self-center ms-2" asp-validation-for="ExpectedUpdateInterval"></span>
</div>

<div class="d-flex mt-1 ms-3 text-nowrap">
    <span class="d-flex align-items-center" style="min-width: 18rem">
        Sensitivity sensor(s) interval <i class='fas fa-question-circle ps-1' title='Time format: dd.hh:mm:ss min value 00:01:00. If the sensor doesn`t return to Ok status after the specified time inverval, a notification sends'></i>
    </span>
    <div class="pb-0" style="width: 17rem;">
        <label id="labelRestoreInterval" class="col-form-label py-0">@Model.SensorRestorePolicy.DisplayInterval</label>
        <div id="partialRestoreSelect" class="d-none">
            <partial name="_TimeIntervalSelect" for="SensorRestorePolicy"/>
        </div>
    </div>
    <span class="d-flex align-self-center ms-2" asp-validation-for="SensorRestorePolicy"></span>
</div>


@foreach (var (type, alerts) in Model.DataAlerts)
{
    <div id="dataAlertsList_@type">
        <div class="d-flex align-items-center">
            <label class="col-form-label fw-bold">@type data alerts:</label>
            <div id="addDataAlert" class="d-none ms-2">
                <a data-bs-toggle="popover" title="Custom comment variables" data-bs-html="true"
                   data-bs-content="There is the next variables: $value, $time, $product, $path, $sensor, $status, $comment, $target, $action">
                    <i class="fas fa-question-circle"></i>
                </a>
                <a href="javascript:addDataAlert('@type');" class="mx-2">
                    <i class="fa-solid fa-plus"></i> Add
                </a>
            </div>
        </div>

        @foreach (var alert in alerts)
        {
            @await Html.PartialAsync("_DataAlert", alert)
        }
    </div>
}


<script>
    $(document).ready(function() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    });

    function addDataAlert(type) {
        $.ajax({
            url: `@Url.Action(nameof(HomeController.AddDataPolicy), ViewConstants.HomeController)?type=${type}`,
            cache: false
        }).done(function (viewData) {
            $(`#dataAlertsList_${type}`).append(viewData);
        });
    }
</script>