@using HSMServer.Controllers
@using HSMServer.Constants
@using HSMServer.Model.ViewModel
@model ProductInfoViewModel

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@await  Html.PartialAsync("_MetaInfo", Model)
<script>
    disableProductExpectedUpdateInterval();

    $(document).on("submit", "#editMetaInfo_form", function (event) {
        event.preventDefault();
        event.stopImmediatePropagation();

        $.ajax({
            url: $("#editMetaInfo_form").attr("action"),
            type: 'POST',
            data: new FormData(this),
            datatype: 'html',
            processData: false,
            contentType: false,
            cache: false,
            async: true,
            success: function (viewData) {
                $('#editButtonMetaInfo').attr('hidden', false);
                $('#meta_info_' + $('#metaInfo_encodedId').val()).html(viewData);
                let metaInfo = $('#metaInfoCollapse');
                
                metaInfo.addClass('no-transition');
                $('#meta_info_collapse').click();
                metaInfo.removeClass('no-transition');
            }
        });
    });

    function editProductInfoButtonClick() {
        let productId = $('#metaInfo_encodedId').val();

        //new functionality
        
        $('#editButtonMetaInfo').addClass('d-none');
        $('#editMetaInfo_form').children('div').each(function () {
                $(this).removeClass('d-none');
        });
        
        $('#meta_info_collapse').addClass('d-none');
        $('[id^="markdown_span_description_"]').addClass('d-none')
        $('[id^="description_"]').removeClass('d-none')
        //end
        
        
        $('#saveInfo_' + productId).removeAttr("disabled").removeAttr("hidden");
        $('#revertInfo_' + productId).removeAttr("disabled").removeAttr("hidden");
        $('#description_' + productId).removeAttr("disabled").removeClass("naked-text");

        $('#meta_info_collapse').attr('hidden', true);

        $('#partialIntervalSelect').removeClass('d-none');
        $('#partialRestoreSelect').removeClass('d-none');

        $('#labelInterval').addClass('d-none');
        $('#labelRestoreInterval').addClass('d-none');

        $(`#productExpectedUpdateInterval_${productId}:input`).each(() => this.removeAttribute('disabled'));
        $(`#productRestorePolicy_${productId}:input`).each(() => this.removeAttribute('disabled'));
    }

    function revertProductInfoClick() {
        let id = $('#metaInfo_encodedId').val();

        $.ajax({
            type: 'GET',
            url: `@Html.Raw(Url.Action(nameof(HomeController.GetProductInfo), ViewConstants.HomeController))?Id=${id}`,
            dataType: 'html',
            contentType: 'application/json',
            cache: false,
            async: true
        }).done(function (viewData) {
            $('#product_info_' + id).html(viewData);
            $('#editProductButton').attr('hidden', false);

            disableProductExpectedUpdateInterval();
             let metaInfo = $('#metaInfoCollapse');
                            
             metaInfo.addClass('no-transition');
             $('#meta_info_collapse').click();
             metaInfo.removeClass('no-transition');
        });
    }

    function disableProductExpectedUpdateInterval() {
        let productId = $('#metaInfo_encodedId').val();

        $(`#productExpectedUpdateInterval_${productId}:input`).each(() => this.setAttribute('disabled', true));
        $(`#productRestorePolicy_${productId}:input`).each(() => this.setAttribute('disabled', true));
    }
</script>