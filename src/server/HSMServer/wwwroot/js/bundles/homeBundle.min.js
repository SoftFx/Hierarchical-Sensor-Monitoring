function getMimeType(fileName){let extension=getExtensionFromName(fileName),fileType=mimeTypesMap.get(extension);return fileType===undefined&&(fileType="text/html"),fileType}function getExtensionFromName(fileName){let dotIndex=fileName.indexOf(".");return dotIndex===-1?fileName:fileName.substring(dotIndex+1,fileName.length)}function openFileInBrowser(path,fileName,viewFileAction){let fileType=getMimeType(fileName);$("#spinner").css("display","block");$("#mainContainer").css("display","none");$("#navbar").css("display","none");$.ajax({type:"POST",url:viewFileAction+"?Selected="+path,cache:!1,contentType:"application/json",success:function(response){fileType===undefined&&(fileType="text/html");let blob=new Blob([response],{type:fileType}),url=window.URL.createObjectURL(blob);window.open(url);$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")},error:function(){console.log("Failed to load file!");$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")}})}function Data(to,from,type,encodedId){return{To:to,From:from,Type:type,EncodedId:encodedId}}function displayGraph(graphData,graphType,graphElementId,graphName){var layout,config;let convertedData=convertToGraphData(graphData,graphType,graphName),zoomData=getPreviousZoomData(graphElementId);if(zoomData===undefined||zoomData===null)layout={autosize:!0},config={responsive:!0},Plotly.newPlot(graphElementId,convertedData,layout,config);else{let layout=createLayoutFromZoomData(zoomData);config={responsive:!0};Plotly.newPlot(graphElementId,convertedData,layout,config)}let graphDiv=document.getElementById(graphElementId);graphDiv.on("plotly_relayout",function(eventData){window.sessionStorage.setItem(graphElementId,JSON.stringify(eventData))})}function createLayoutFromZoomData(zoomData){let processedData=Object.values(JSON.parse(zoomData));return{xaxis:{range:[processedData[0],processedData[1]]},yaxis:{range:[processedData[2],processedData[3]]},autosize:!0}}function getPreviousZoomData(graphElementId){return window.sessionStorage.getItem(graphElementId)}function convertToGraphData(graphData,graphType,graphName){let escapedData=JSON.parse(graphData),data,timeList;switch(graphType){case"0":return data=getBoolData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"bar");case"1":return data=getNumbersData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"2":return data=getNumbersData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"4":return createBarGraphData(escapedData,graphName);case"5":return createBarGraphData(escapedData,graphName);default:return undefined}}function getPlotType(graphType){return graphType===1||graphType===2?"scatter":graphType===4||graphType===5?"box":undefined}function initializeInfoLinks(){$('[id^="sensorInfo_link_"]').off("click").on("click",metaInfoLinkClicked)}function metaInfoLinkClicked(){let sensorId=this.id.substring(16);$("#sensor_info_"+sensorId).is(":empty")?showMetaInfo(sensorId):hideMetaInfo(sensorId)}function showMetaInfo(id){$.ajax({type:"GET",url:getSensorInfoAction+"?Id="+id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(data){displaySensorMetaInfo(id,data);setLinkText(id,"Hide meta info")})}function hideMetaInfo(sensorId){$("#sensor_info_"+sensorId).empty();setLinkText(sensorId,"Show meta info")}function setLinkText(sensorId,text){let link=document.getElementById("sensorInfo_link_"+sensorId);link.textContent=text}function disableExpectedUpdateIntervalControl(){let sensorId=$("#sensorMetaInfo_encodedId").val();$("#expectedUpdateInterval_"+sensorId+" :input").each(function(){this.setAttribute("disabled",!0)})}function editInfoButtonClick(){let sensorId=$("#sensorMetaInfo_encodedId").val();$("#interval_"+sensorId).removeAttr("disabled");$("#description_"+sensorId).removeAttr("disabled");$("#unit_"+sensorId).removeAttr("disabled");$("#saveInfo_"+sensorId).removeAttr("disabled");$("#revertInfo_"+sensorId).removeAttr("disabled");$("#expectedUpdateInterval_"+sensorId+" :input").each(function(){this.removeAttribute("disabled")})}function revertInfoClick(){let sensorId=$("#sensorMetaInfo_encodedId").val();showMetaInfo(sensorId)}function displaySensorMetaInfo(sensorId,viewData){$("#sensor_info_"+sensorId).html(viewData);disableExpectedUpdateIntervalControl()}function initializeUserRights(userIsAdmin,userProducts){isCurrentUserAdmin=userIsAdmin;currentUserProducts=userProducts.split(" ")}function initializeTree(){$("#jstree").jstree({core:{check_callback:!0,themes:{name:"proton",responsive:!0}},contextmenu:{items:customMenu},plugins:["state","contextmenu","themes","wholerow","sort"],sort:function(a,b){var isTimeSort=$("input[name='TreeSortType']:checked").val()=="1";return isTimeSort?(nodeA=this.get_node(a),nodeB=this.get_node(b),format="DD/MM/YYYY hh:mm:ss",timeA=moment(nodeA.data.jstree.time,format),timeB=moment(nodeB.data.jstree.time,format),timeSorting(timeA,timeB)):(a=this.get_node(a).data.jstree.title.toLowerCase(),b=this.get_node(b).data.jstree.title.toLowerCase(),a>b?1:-1)}}).on("state_ready.jstree",function(){selectNodeAjax($(this).jstree("get_selected"))});$("#updateTime").empty();$("#updateTime").append("Update Time: "+(new Date).toUTCString());initializeActivateNodeTree()}function initializeActivateNodeTree(){$("#jstree").on("activate_node.jstree",function(e,data){selectNodeAjax(data.node.id)})}function selectNodeAjax(selectedId){$.ajax({type:"post",url:selectNode+"?Selected="+selectedId,datatype:"html",contenttype:"application/json",cache:!1,success:function(viewData){$("#listSensors").html(viewData)}}).done(function(){initialize();var selectedAccordionId="#accordion_"+selectedId;$(selectedAccordionId).attr("aria-expanded")=="false"&&$(selectedAccordionId).click();needToActivateListTab?(selectNodeInfoTab("list",selectedId),needToActivateListTab=!1):selectNodeInfoTab("grid",selectedId)})}function selectNodeInfoTab(tab,selectedId){let tabLink=document.getElementById(`${tab}Link_${selectedId}`);tabLink!=null&&tabLink.click()}function activateNode(currentNodeId,nodeIdToActivate){needToActivateListTab=$(`#list_${currentNodeId}`).hasClass("active");$("#jstree").jstree("activate_node",nodeIdToActivate)}function timeSorting(a,b){return b.diff(a)}function customMenu(node){var tree=$("#jstree").jstree(!0),items={AccessKeys:{separator_before:!1,separator_after:!1,label:"Access keys",action:function(){showAccessKeysList(node.id,!0)}},CopyPath:{separator_before:!1,separator_after:!1,label:"Copy path",action:function(){$.ajax({type:"POST",url:getPath+"?Selected="+node.id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(data){copyToClipboard(data)})}},Edit:{separator_before:!1,separator_after:!1,label:"Edit",action:function(){node.parents.length==1?window.location.href=editProduct+"?Product="+node.id:node.children.length==0&&$("#sensorInfo_link_"+node.id).click()}},BlockSensor:{separator_before:!1,separator_after:!1,label:"Block sensor",icon:"fa-solid fa-ban",action:function(){changeSensorBlockedState(node,!0)}},UnblockSensor:{separator_before:!1,separator_after:!1,label:"Unblock sensor",icon:"fa-solid fa-ban",action:function(){changeSensorBlockedState(node,!1)}},CleanHistory:{separator_before:!1,separator_after:!0,label:"Clean history",action:function(){$("#modalDeleteLabel").empty();$("#modalDeleteLabel").append("Remove node");$("#modalDeleteBody").empty();$("#modalDeleteBody").append('Do you really want to remove "'+node.text+'" node?');var modal=new bootstrap.Modal(document.getElementById("modalDelete"));modal.show();$("#confirmDeleteButton").off("click").on("click",function(){modal.hide();$.ajax({type:"POST",url:removeNode+"?Selected="+node.id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(){updateTreeTimer()})});$("#closeDeleteButton").off("click").on("click",function(){modal.hide()})}},Notifications:{separator_before:!1,separator_after:!1,label:"Private notifications",submenu:{EnableNotifications:{separator_before:!1,separator_after:!1,label:"Enable",icon:"fab fa-telegram",action:function(){updateSensorsNotifications(enableNotifications,node)}},DisableNotifications:{separator_before:!1,separator_after:!1,label:"Disable",icon:"fab fa-telegram",action:function(){updateSensorsNotifications(disableNotifications,node)}},IgnoreNotifications:{separator_before:!1,separator_after:!1,label:"Ignore",icon:"fa-solid fa-bell-slash",action:function(){$.ajax({type:"get",url:ignoreNotifications+"?Selected="+node.id,datatype:"html",contenttype:"application/json",cache:!1,success:function(viewData){$("#ignoreNotificatios_partial").html(viewData)}}).done(function(){$("#ignoreNotifications_modal").modal("show")})}},RemoveIgnoreNotifications:{separator_before:!1,separator_after:!1,label:"Remove ignoring",icon:"fa-solid fa-bell",action:function(){updateSensorsNotifications(removeIgnoringNotifications,node)}}}}};if(node.parents.length!=1&&(delete items.AccessKeys,node.children.length!=0&&delete items.Edit),hasUserNodeRights(node)&&node.children.length==0&&node.parents.length!=1||(delete items.BlockSensor,delete items.UnblockSensor),$(`#${node.id} span.blockedSensor-span`).length===0?delete items.UnblockSensor:delete items.BlockSensor,document.getElementById(`${node.id}_ignoreNotifications`))delete items.Notifications.submenu.EnableNotifications,delete items.Notifications.submenu.IgnoreNotifications;else if(document.getElementById(`${node.id}_notifications`)){let partialNotifications=$(`#${node.id}_partialNotifications`).val();partialNotifications!=="True"&&delete items.Notifications.submenu.EnableNotifications;delete items.Notifications.submenu.RemoveIgnoreNotifications}else delete items.Notifications.submenu.DisableNotifications,delete items.Notifications.submenu.IgnoreNotifications,delete items.Notifications.submenu.RemoveIgnoreNotifications;return items}function updateSensorsNotifications(action,node){$.ajax({type:"post",url:action+"?Selected="+node.id,datatype:"html",contenttype:"application/json",cache:!1}).done(function(){updateTreeTimer()})}function changeSensorBlockedState(node,isBlocked){$.ajax({type:"post",url:changeSensorState+"?Selected="+node.id+"&Block="+isBlocked,datatype:"html",contenttype:"application/json",cache:!1,success:function(){updateTreeTimer()}})}function hasUserNodeRights(node){let productId=node.parents.length===1?node.id:node.parents[node.parents.length-2];return isCurrentUserAdmin==="True"||currentUserProducts.includes(productId)}var millisecondsInHour,millisecondsInDay;const mimeTypesMap=new Map;mimeTypesMap.set("html","text/html");mimeTypesMap.set("pdf","application/pdf");millisecondsInHour=36e5;millisecondsInDay=millisecondsInHour*24;Date.prototype.AddDays=function(days){let date=new Date(this.valueOf());return date.setDate(date.getDate()+days),date};Date.prototype.AddHours=function(hours){let newDate=new Date(this.valueOf());return newDate.setHours(newDate.getHours()+hours),newDate};{function initialize(){initializeSensorAccordion();initializeFileSensorEvents();initializeInfoLinks()}function initializeSensorAccordion(){$('[id^="collapse"]').off("show.bs.collapse",accordionClicked);$('[id^="collapse"]').on("show.bs.collapse",accordionClicked);InitializePeriodRequests();initializeTabLinksRequests()}function initializeFileSensorEvents(){$('[id^="button_view_"]').off("click",viewFile);$('[id^="button_view_"]').on("click",viewFile);$('[id^="button_download_"]').off("click",downloadFile);$('[id^="button_download_"]').on("click",downloadFile)}function downloadFile(){let encodedId=this.id.substring(16);window.location.href=getFileAction+"?Selected="+encodedId}function viewFile(){let encodedId=this.id.substring(12),fileType=document.getElementById("fileType_"+encodedId).value;openFileInBrowser(encodedId,fileType,viewFileAction)}function accordionClicked(){let encodedId=this.id.substring(9),type=getTypeForSensor(encodedId),from=new Date;isFileSensor(type)||(isGraphAvailable(type)?initializeGraph(encodedId,rawHistoryLatestAction,type,Data(from,from,type,encodedId),!0):initializeTable(encodedId,historyLatestAction,type,Data(from,from,type,encodedId),!0))}function initializeTabLinksRequests(){$('[id^="link_graph_"]').off("click").on("click",requestGraph);$('[id^="link_table_"]').off("click").on("click",requestTable)}function requestGraph(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);let body=Data(to,from,type,encodedId),action=isAllHistorySelected(encodedId)?rawHistoryAllAction:rawHistoryAction;initializeGraph(encodedId,action,type,body,!1)}function requestTable(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);let body=Data(to,from,type,encodedId),action=isAllHistorySelected(encodedId)?historyAllAction:historyAction;initializeTable(encodedId,action,type,body,!1)}function InitializePeriodRequests(){$('[id^="radio_hour_"]').off("click").on("click",requestHistoryHour);$('[id^="radio_day_"]').off("click").on("click",requestHistoryDay);$('[id^="radio_three_days_"]').off("click").on("click",requestHistoryThreeDays);$('[id^="radio_week_"]').off("click").on("click",requestHistoryWeek);$('[id^="radio_month_"]').off("click").on("click",requestHistoryMonth);$('[id^="radio_all_"]').off("click").on("click",requestHistoryAll);$('[id^="button_export_csv_"]').off("click").on("click",exportCsv)}function requestHistoryHour(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const to=new Date,from=to.AddHours(-1);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}function requestHistoryDay(){let encodedId=this.id.substring(10),type=getTypeForSensor(encodedId);const to=new Date,from=to.AddDays(-1);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}function requestHistoryThreeDays(){let encodedId=this.id.substring(17),type=getTypeForSensor(encodedId);const to=new Date,from=to.AddDays(-3);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}function requestHistoryWeek(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const to=new Date,from=to.AddDays(-7);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}function requestHistoryMonth(){let encodedId=this.id.substring(12),type=getTypeForSensor(encodedId);const to=new Date,from=to.AddDays(-30);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}function requestHistoryAll(){let encodedId=this.id.substring(10),type=getTypeForSensor(encodedId);requestHistory(encodedId,historyAllAction,rawHistoryAllAction,type,{})}}{function requestHistory(encodedId,action,rawAction,type,reqData){if(!isGraphAvailable(type)){initializeTable(encodedId,action,type,reqData,!1);return}isTableHistorySelected(encodedId)?initializeTable(encodedId,action,type,reqData,!1):initializeGraph(encodedId,rawAction,type,reqData,!1)}function exportCsv(){let encodedId=this.id.substring(18),type=getTypeForSensor(encodedId);if(isAllHistorySelected(encodedId)){window.location.href=exportHistoryAllAction+"?EncodedId="+encodedId+"&Type="+type;return}const{from,to}=getFromAndTo(encodedId);window.location.href=exportHistoryAction+"?EncodedId="+encodedId+"&Type="+type+"&From="+from.toISOString()+"&To="+to.toISOString()}function initializeTable(encodedId,tableAction,type,body,needSetRadio){$.ajax({type:"POST",data:JSON.stringify(body),url:tableAction+"?EncodedId="+encodedId+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,"async":!0}).done(function(data){$(`#values_${encodedId}`).html(data);let noValuesElement=document.getElementById(`noTableValues_${encodedId}`);if(noValuesElement!=null){$("#history_"+encodedId).hide();$("#no_data_"+encodedId).show();return}$("#history_"+encodedId).show();$("#no_data_"+encodedId).hide();needSetRadio&&selectRadioForTable(encodedId)})}function initializeGraph(encodedId,rawHistoryAction,type,body,needSetRadio){$.ajax({type:"POST",data:JSON.stringify(body),url:rawHistoryAction+"?EncodedId="+encodedId+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,"async":!0}).done(function(data){if(JSON.parse(data).length===0){$("#history_"+encodedId).hide();$("#no_data_"+encodedId).show();return}$("#history_"+encodedId).show();$("#no_data_"+encodedId).hide();let graphDivId="graph_"+encodedId;needSetRadio&&selectAppropriateRadio(data,encodedId);displayGraph(data,type,graphDivId,encodedId)})}}{function selectRadioForTable(encodedId){let currentDate=new Date(Date.parse((new Date).toUTCString())),oldestDate=getOldestDateFromTable(encodedId),difference=currentDate-oldestDate;selectRadioViaDifference(difference,encodedId)}function getOldestDateFromTable(encodedId){let val=$("#oldest_date_"+encodedId).val();return new Date(Date.parse(val))}function selectAppropriateRadio(data,encodedId){let parsedData=JSON.parse(data),currentDate=new Date(Date.parse((new Date).toUTCString())),firstDate=new Date(Date.parse(parsedData[0].time)),difference=currentDate-firstDate;selectRadioViaDifference(difference,encodedId)}function selectRadioViaDifference(difference,encodedId){if(difference<=millisecondsInHour){$("#radio_hour_"+encodedId).prop("checked",!0);return}if(difference<=millisecondsInDay){$("#radio_day_"+encodedId).prop("checked",!0);return}if(difference<=3*millisecondsInDay){$("#radio_three_days_"+encodedId).prop("checked",!0);return}if(difference<=7*millisecondsInDay){$("#radio_week_"+encodedId).prop("checked",!0);return}if(difference<=30*millisecondsInDay){$("#radio_month_"+encodedId).prop("checked",!0);return}$("#radio_all_"+encodedId).prop("checked",!0)}function isFileSensor(type){return type==="6"||type==="7"}function isGraphAvailable(type){return!(type==="3"||type==="6"||type==="7")}function isTableHistorySelected(encodedId){let el=$("#values_parent_"+encodedId);return el.hasClass("show")}function isAllHistorySelected(encodedId){return $("#radio_all_"+encodedId).is(":checked")}function getFromAndTo(encodedId){let from=null,to=null;return $("#radio_hour_"+encodedId).is(":checked")&&(to=new Date,from=to.AddHours(-1)),$("#radio_day_"+encodedId).is(":checked")&&(to=new Date,from=to.AddDays(-1)),$("#radio_three_days_"+encodedId).is(":checked")&&(to=new Date,from=to.AddDays(-3)),$("#radio_week_"+encodedId).is(":checked")&&(to=new Date,from=to.AddDays(-7)),$("#radio_month_"+encodedId).is(":checked")&&(to=new Date,from=to.AddDays(-30)),{from,to}}function getCountForId(id){let inputCount=$("#inputCount_"+id).val();return inputCount===undefined&&(inputCount=10),inputCount}function getTypeForSensor(encodedId){return $("#sensor_type_"+encodedId).val()}}{function getBoolData(escapedItems){return escapedItems.map(function(i){let currentBoolean=i.value===!0;return currentBoolean?1:0})}}{function getSimpleGraphData(timeList,dataList,chartType){return[{x:timeList,y:dataList,type:chartType}]}function getNumbersData(escapedItems){return escapedItems.map(function(i){return i.value})}function getTimeList(escapedItems){return escapedItems.map(function(i){return i.time})}}{function getTimeFromBars(escapedBarsData){return escapedBarsData.map(function(d){return d.closeTime.toString().startsWith("0001")?d.openTime:d.closeTime})}function createBarGraphData(escapedBarsData,graphName){let max=getBarsMax(escapedBarsData),min=getBarsMin(escapedBarsData),median=getBarsMedian(escapedBarsData),q1=getBarsQ1(escapedBarsData),q3=getBarsQ3(escapedBarsData),mean=getBarsMean(escapedBarsData),timeList=getTimeFromBars(escapedBarsData);return[{type:"box",name:graphName,q1:q1,median:median,q3:q3,mean:mean,lowerfence:min,upperfence:max,x:timeList}]}{function getBarsMin(escapedBarsData){return escapedBarsData.map(function(d){return d.min})}function getBarsMax(escapedBarsData){return escapedBarsData.map(function(d){return d.max})}function getBarsMedian(escapedBarsData){let medians=[];return escapedBarsData.map(function(d){medians.push(d.percentiles[.5])}),medians}function getBarsQ1(escapedBarsData){let q1s=[];return escapedBarsData.map(function(d){q1s.push(d.percentiles[.25])}),q1s}function getBarsQ3(escapedBarsData){let q3s=[];return escapedBarsData.map(function(d){q3s.push(d.percentiles[.75])}),q3s}function getBarsMean(escapedBarsData){return escapedBarsData.map(function(d){return d.mean})}}}var isCurrentUserAdmin=!1,currentUserProducts=[],needToActivateListTab=!1;