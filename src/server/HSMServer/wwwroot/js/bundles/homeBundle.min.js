function getMimeType(fileName){let extension=getExtensionFromName(fileName),fileType=mimeTypesMap.get(extension);return fileType===undefined&&(fileType="text/html"),fileType}function getExtensionFromName(fileName){let dotIndex=fileName.indexOf(".");return dotIndex===-1?fileName:fileName.substring(dotIndex+1,fileName.length)}function openFileInBrowser(path,fileName,viewFileAction){let fileType=getMimeType(fileName);$("#spinner").css("display","block");$("#mainContainer").css("display","none");$("#navbar").css("display","none");$.ajax({type:"POST",url:viewFileAction+"?Selected="+path,cache:!1,contentType:"application/json",success:function(response){fileType===undefined&&(fileType="text/html");let blob=new Blob([response],{type:fileType}),url=window.URL.createObjectURL(blob);window.open(url);$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")},error:function(){console.log("Failed to load file!");$("#spinner").css("display","none");$("#mainContainer").css("display","block");$("#navbar").css("display","block")}})}function Data(to,from,type,encodedId){return{To:to,From:from,Type:type,EncodedId:encodedId,BarsCount:getBarsCount(encodedId)}}function displayGraph(graphData,graphType,graphElementId,graphName){var layout,config;let convertedData=convertToGraphData(graphData,graphType,graphName),zoomData=getPreviousZoomData(graphElementId);if(zoomData===undefined||zoomData===null)layout={autosize:!0},config={responsive:!0},Plotly.newPlot(graphElementId,convertedData,layout,config);else{let layout=createLayoutFromZoomData(zoomData);config={responsive:!0};Plotly.newPlot(graphElementId,convertedData,layout,config)}let graphDiv=document.getElementById(graphElementId);graphDiv.on("plotly_relayout",function(eventData){window.sessionStorage.setItem(graphElementId,JSON.stringify(eventData))})}function createLayoutFromZoomData(zoomData){let processedData=Object.values(JSON.parse(zoomData));return{xaxis:{range:[processedData[0],processedData[1]]},yaxis:{range:[processedData[2],processedData[3]]},autosize:!0}}function getPreviousZoomData(graphElementId){return window.sessionStorage.getItem(graphElementId)}function convertToGraphData(graphData,graphType,graphName){let escapedData=JSON.parse(graphData),data,timeList;switch(graphType){case"0":const uniqueData=getUniqueData(escapedData);return data=getBoolData(uniqueData),timeList=getTimeList(uniqueData),getSimpleGraphData(timeList,data,"bar");case"1":return data=getNumbersData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"2":return data=getNumbersData(escapedData),timeList=getTimeList(escapedData),getSimpleGraphData(timeList,data,"scatter");case"4":return createBarGraphData(escapedData,graphName);case"5":return createBarGraphData(escapedData,graphName);default:return undefined}}function getPlotType(graphType){return graphType===1||graphType===2?"scatter":graphType===4||graphType===5?"box":undefined}function initializeInfoLinks(){$('[id^="sensorInfo_link_"]').off("click").on("click",metaInfoLinkClicked)}function metaInfoLinkClicked(){let sensorId=this.id.substring(16);$("#sensor_info_"+sensorId).is(":empty")?showMetaInfo(sensorId):hideMetaInfo(sensorId)}function showMetaInfo(id){$.ajax({type:"GET",url:getSensorInfoAction+"?Id="+id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(data){displaySensorMetaInfo(id,data);setLinkText(id,"Hide meta info")})}function hideMetaInfo(sensorId){$("#sensor_info_"+sensorId).empty();setLinkText(sensorId,"Show meta info")}function setLinkText(sensorId,text){let link=document.getElementById("sensorInfo_link_"+sensorId);link.textContent=text}function disableExpectedUpdateIntervalControl(){let sensorId=$("#sensorMetaInfo_encodedId").val();$("#expectedUpdateInterval_"+sensorId+" :input").each(function(){this.setAttribute("disabled",!0)})}function editInfoButtonClick(){let sensorId=$("#sensorMetaInfo_encodedId").val();$("#interval_"+sensorId).removeAttr("disabled");$("#description_"+sensorId).removeAttr("disabled");$("#unit_"+sensorId).removeAttr("disabled");$("#saveInfo_"+sensorId).removeAttr("disabled").removeAttr("hidden");$("#revertInfo_"+sensorId).removeAttr("disabled").removeAttr("hidden");$("#editButtonMetaInfo").attr("hidden","true");$("#expectedUpdateInterval_"+sensorId+" :input").each(function(){this.removeAttribute("disabled")})}function revertInfoClick(){let sensorId=$("#sensorMetaInfo_encodedId").val();showMetaInfo(sensorId)}function displaySensorMetaInfo(sensorId,viewData){$("#sensor_info_"+sensorId).html(viewData);disableExpectedUpdateIntervalControl()}function initializeUserRights(userIsAdmin,userProducts){isCurrentUserAdmin=userIsAdmin;currentUserProducts=userProducts.split(" ")}function initializeTree(){var sortingType=$("input[name='TreeSortType']:checked");$("#jstree").jstree({core:{check_callback:!0,themes:{name:"proton",responsive:!0}},contextmenu:{items:customMenu},plugins:["state","contextmenu","themes","wholerow","sort"],sort:function(a,b){let isTimeSort=sortingType.val()=="1";return isTimeSort?(nodeA=this.get_node(a),nodeB=this.get_node(b),format="DD/MM/YYYY hh:mm:ss",timeA=moment(nodeA.data.jstree.time,format),timeB=moment(nodeB.data.jstree.time,format),timeSorting(timeA,timeB)):(a=this.get_node(a).data.jstree.title.toLowerCase(),b=this.get_node(b).data.jstree.title.toLowerCase(),a>b?1:-1)}}).on("state_ready.jstree",function(){selectNodeAjax($(this).jstree("get_selected"))});initializeActivateNodeTree()}function initializeActivateNodeTree(){$("#jstree").on("activate_node.jstree",function(e,data){data.node.id!=undefined&&selectNodeAjax(data.node.id)})}function selectNodeAjax(selectedId){if(currentSelectedNodeId!=selectedId){currentSelectedNodeId=selectedId;var selectedNode=$("#jstree").jstree().get_node(selectedId);(!selectedNode||selectedNode.children.length>20||selectedNode.children.length==0)&&($("#nodeDataSpinner").css("display","block"),$("#nodeDataPanel").addClass("hidden_element"));$.ajax({type:"post",url:selectNode+"?Selected="+selectedId,datatype:"html",contenttype:"application/json",cache:!1,success:function(viewData){$("#nodeDataPanel").html(viewData)}}).done(function(){initialize();openAccordions('[id^="grid-accordion_"]');openAccordions('[id^="list-accordion_"]');var selectedAccordionId="#accordion_"+selectedId;$(selectedAccordionId).attr("aria-expanded")=="false"&&$(selectedAccordionId).click();needToActivateListTab?(selectNodeInfoTab("list",selectedId),needToActivateListTab=!1):selectNodeInfoTab("grid",selectedId);$("#nodeDataSpinner").css("display","none");$("#nodeDataPanel").removeClass("hidden_element")})}}function openAccordions(accordionsId){let accordions=document.querySelectorAll(accordionsId);accordions.forEach(element=>{element.getAttribute("aria-expanded")=="false"&&element.click()})}function selectNodeInfoTab(tab,selectedId){let tabLink=document.getElementById(`${tab}Link_${selectedId}`);tabLink!=null&&tabLink.click()}function activateNode(currentNodeId,nodeIdToActivate){needToActivateListTab=$(`#list_${currentNodeId}`).hasClass("active");$("#jstree").jstree("activate_node",nodeIdToActivate);currentSelectedNodeId!=nodeIdToActivate&&selectNodeAjax(nodeIdToActivate)}function timeSorting(a,b){return b.diff(a)}function customMenu(node){var tree=$("#jstree").jstree(!0),items={AccessKeys:{separator_before:!1,separator_after:!1,label:"Access keys",action:function(){showAccessKeysList(node.id,!0)}},CopyPath:{separator_before:!1,separator_after:!1,label:"Copy path",action:function(){$.ajax({type:"POST",url:getPath+"?Selected="+node.id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(data){copyToClipboard(data)})}},Edit:{separator_before:!1,separator_after:!1,label:"Edit",action:function(){node.parents.length==1?window.location.href=editProduct+"?Product="+node.id:node.children.length==0&&$("#sensorInfo_link_"+node.id).click()}},CleanHistory:{separator_before:!1,separator_after:!0,label:"Clean history",action:function(){$("#modalDeleteLabel").empty();$("#modalDeleteLabel").append("Remove node");$("#modalDeleteBody").empty();$("#modalDeleteBody").append('Do you really want to remove "'+node.text+'" node?');var modal=new bootstrap.Modal(document.getElementById("modalDelete"));modal.show();$("#confirmDeleteButton").off("click").on("click",function(){modal.hide();$.ajax({type:"POST",url:removeNode+"?Selected="+node.id,dataType:"html",contentType:"application/json",cache:!1,"async":!0}).done(function(){updateTreeTimer()})});$("#closeDeleteButton").off("click").on("click",function(){modal.hide()})}},Notifications:{separator_before:!1,separator_after:!1,label:"Private notifications",submenu:{EnableNotifications:{separator_before:!1,separator_after:!1,label:"Enable",icon:"fab fa-telegram",action:function(){updateSensorsNotifications(enableNotifications,node)}},DisableNotifications:{separator_before:!1,separator_after:!1,label:"Disable",icon:"fab fa-telegram",action:function(){updateSensorsNotifications(disableNotifications,node)}},IgnoreNotifications:{separator_before:!1,separator_after:!1,label:"Ignore",icon:"fa-solid fa-bell-slash",action:function(){$.ajax({type:"get",url:ignoreNotifications+"?Selected="+node.id,datatype:"html",contenttype:"application/json",cache:!1,success:function(viewData){$("#ignoreNotificatios_partial").html(viewData)}}).done(function(){$("#ignoreNotifications_modal").modal("show")})}},RemoveIgnoreNotifications:{separator_before:!1,separator_after:!1,label:"Remove ignoring",icon:"fa-solid fa-bell",action:function(){updateSensorsNotifications(removeIgnoringNotifications,node)}}}}};if(node.parents.length!=1&&(delete items.AccessKeys,node.children.length!=0&&delete items.Edit),document.getElementById(`${node.id}_ignoreNotifications`))delete items.Notifications.submenu.EnableNotifications,delete items.Notifications.submenu.IgnoreNotifications;else if(document.getElementById(`${node.id}_notifications`)){let partialNotifications=$(`#${node.id}_partialNotifications`).val();partialNotifications!=="True"&&delete items.Notifications.submenu.EnableNotifications;delete items.Notifications.submenu.RemoveIgnoreNotifications}else delete items.Notifications.submenu.DisableNotifications,delete items.Notifications.submenu.IgnoreNotifications,delete items.Notifications.submenu.RemoveIgnoreNotifications;return items}function updateSensorsNotifications(action,node){$.ajax({type:"post",url:action+"?Selected="+node.id,datatype:"html",contenttype:"application/json",cache:!1}).done(function(){updateTreeTimer()})}function changeSensorBlockedState(node,isBlocked){$.ajax({type:"post",url:changeSensorState+"?Selected="+node.id+"&Block="+isBlocked,datatype:"html",contenttype:"application/json",cache:!1,success:function(){updateTreeTimer()}})}function hasUserNodeRights(node){let productId=node.parents.length===1?node.id:node.parents[node.parents.length-2];return isCurrentUserAdmin==="True"||currentUserProducts.includes(productId)}var millisecondsInHour,millisecondsInDay;const mimeTypesMap=new Map;mimeTypesMap.set("html","text/html");mimeTypesMap.set("pdf","application/pdf");millisecondsInHour=36e5;millisecondsInDay=millisecondsInHour*24;Date.prototype.AddDays=function(days){let date=new Date(this.valueOf());return date.setDate(date.getDate()+days),date};Date.prototype.AddHours=function(hours){let newDate=new Date(this.valueOf());return newDate.setHours(newDate.getHours()+hours),newDate};{function initialize(){initializeSensorAccordion();initializeFileSensorEvents();initializeInfoLinks()}function initializeSensorAccordion(){$('[id^="collapse"]').off("show.bs.collapse",accordionClicked);$('[id^="collapse"]').on("show.bs.collapse",accordionClicked);InitializePeriodRequests();initializeTabLinksRequests()}function initializeFileSensorEvents(){$('[id^="button_view_"]').off("click",viewFile);$('[id^="button_view_"]').on("click",viewFile);$('[id^="button_download_"]').off("click",downloadFile);$('[id^="button_download_"]').on("click",downloadFile)}function downloadFile(){let encodedId=this.id.substring(16);window.location.href=getFileAction+"?Selected="+encodedId}function viewFile(){let encodedId=this.id.substring(12),fileType=document.getElementById("fileType_"+encodedId).value;openFileInBrowser(encodedId,fileType,viewFileAction)}function accordionClicked(){let encodedId=this.id.substring(9),type=getTypeForSensor(encodedId),date=new Date;isFileSensor(type)||(isGraphAvailable(type)?initializeGraph(encodedId,rawHistoryLatestAction,type,Data(date,date,type,encodedId),!0):initializeTable(encodedId,historyLatestAction,type,Data(date,date,type,encodedId),!0))}function initializeTabLinksRequests(){$('[id^="link_graph_"]').off("click").on("click",requestGraph);$('[id^="link_table_"]').off("click").on("click",requestTable)}function requestGraph(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);let body=Data(to,from,type,encodedId);showBarsCount(encodedId);initializeGraph(encodedId,rawHistoryAction,type,body)}function requestTable(){let encodedId=this.id.substring(11),type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);let body=Data(to,from,type,encodedId);hideBarsCount(encodedId);initializeTable(encodedId,historyAction,type,body)}function InitializePeriodRequests(){$('[id^="button_export_csv_"]').off("click").on("click",exportCsv)}function searchHistory(encodedId){let type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);requestHistory(encodedId,historyAction,rawHistoryAction,type,Data(to,from,type,encodedId))}}{function requestHistory(encodedId,action,rawAction,type,reqData){if(!isGraphAvailable(type)){initializeTable(encodedId,action,type,reqData);return}isTableHistorySelected(encodedId)?initializeTable(encodedId,action,type,reqData):initializeGraph(encodedId,rawAction,type,reqData)}function exportCsv(){let encodedId=this.id.substring(18),type=getTypeForSensor(encodedId);const{from,to}=getFromAndTo(encodedId);window.location.href=exportHistoryAction+"?EncodedId="+encodedId+"&Type="+type+"&From="+from+"&To="+to}function initializeTable(encodedId,tableAction,type,body,needFillFromTo=false){$.ajax({type:"POST",data:JSON.stringify(body),url:tableAction+"?EncodedId="+encodedId+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,"async":!0}).done(function(data){$(`#values_${encodedId}`).html(data);let noValuesElement=document.getElementById(`noTableValues_${encodedId}`);if(noValuesElement!=null){$("#history_"+encodedId).hide();$("#no_data_"+encodedId).show();return}if($("#history_"+encodedId).show(),$("#no_data_"+encodedId).hide(),needFillFromTo){let from=new Date($(`#oldest_date_${encodedId}`).val());from.setMinutes(from.getMinutes()-from.getTimezoneOffset());let to=new Date;$(`#from_${encodedId}`).val(datetimeLocal(from));$(`#to_${encodedId}`).val(datetimeLocal(to))}})}function initializeGraph(encodedId,rawHistoryAction,type,body,needFillFromTo=false){$.ajax({type:"POST",data:JSON.stringify(body),url:rawHistoryAction+"?EncodedId="+encodedId+"&Type="+type,contentType:"application/json",dataType:"html",cache:!1,"async":!0}).done(function(data){let parsedData=JSON.parse(data);if(parsedData.length===0){$("#history_"+encodedId).hide();$("#no_data_"+encodedId).show();return}if($("#history_"+encodedId).show(),$("#no_data_"+encodedId).hide(),needFillFromTo){let from=new Date(parsedData[0].time),to=new Date;$(`#from_${encodedId}`).val(datetimeLocal(from));$(`#to_${encodedId}`).val(datetimeLocal(to))}displayGraph(data,type,`graph_${encodedId}`,encodedId)})}}{function isFileSensor(type){return type==="6"||type==="7"}function isGraphAvailable(type){return!(type==="3"||type==="6"||type==="7")}function isTableHistorySelected(encodedId){let el=$("#values_parent_"+encodedId);return el.hasClass("show")}function getFromAndTo(encodedId){let from=$(`#from_${encodedId}`).val(),to=$(`#to_${encodedId}`).val();return to==""&&(to=new Date,$(`#to_${encodedId}`).val(datetimeLocal(to))),from==""&&(from=to.AddDays(-1),$(`#from_${encodedId}`).val(datetimeLocal(from))),{from,to}}function datetimeLocal(datetime){const dt=new Date(datetime);return dt.toISOString().slice(0,16)}function hideBarsCount(encodedId){$(`#labelBarsCount_${encodedId}`).hide();$(`#barsCount_${encodedId}`).hide()}function showBarsCount(encodedId){$(`#labelBarsCount_${encodedId}`).show();$(`#barsCount_${encodedId}`).show()}function getBarsCount(encodedId){let barsCount=$(`#barsCount_${encodedId}`).val();return barsCount==""||barsCount==undefined?setBarsCount(encodedId,100):barsCount>1e3?setBarsCount(encodedId,1e3):barsCount<1?setBarsCount(encodedId,1):barsCount}function setBarsCount(encodedId,count){return $(`#barsCount_${encodedId}`).val(count),count}function getTypeForSensor(encodedId){return $("#sensor_type_"+encodedId).val()}}{function showPage(getPageAction,encodedId){$("#nextPageButton").addClass("disabled");$("#prevPageButton").addClass("disabled");$.ajax({type:"GET",url:getPageAction,contentType:"application/json",dataType:"html",cache:!1,"async":!0}).done(function(data){$(`#values_${encodedId}`).html(data)})}}{function getBoolData(escapedItems){return escapedItems.map(function(i){let currentBoolean=i.value===!0;return currentBoolean?1:0})}function getUniqueData(data){return[...new Map(data.map(item=>[item.time,item])).values()]}}{function getSimpleGraphData(timeList,dataList,chartType){return[{x:timeList,y:dataList,type:chartType}]}function getNumbersData(escapedItems){return escapedItems.map(function(i){return i.value})}function getTimeList(escapedItems){return escapedItems.map(function(i){return i.time})}}{function getTimeFromBars(escapedBarsData){return escapedBarsData.map(function(d){return d.closeTime.toString().startsWith("0001")?d.openTime:d.closeTime})}function createBarGraphData(escapedBarsData,graphName){let max=getBarsMax(escapedBarsData),min=getBarsMin(escapedBarsData),median=getBarsMedian(escapedBarsData),q1=getBarsQ1(escapedBarsData),q3=getBarsQ3(escapedBarsData),mean=getBarsMean(escapedBarsData),timeList=getTimeFromBars(escapedBarsData);return[{type:"box",name:graphName,q1:q1,median:median,q3:q3,mean:mean,lowerfence:min,upperfence:max,x:timeList}]}{function getBarsMin(escapedBarsData){return escapedBarsData.map(function(d){return d.min})}function getBarsMax(escapedBarsData){return escapedBarsData.map(function(d){return d.max})}function getBarsMedian(escapedBarsData){let medians=[];return escapedBarsData.map(function(d){medians.push(d.percentiles[.5])}),medians}function getBarsQ1(escapedBarsData){let q1s=[];return escapedBarsData.map(function(d){q1s.push(d.percentiles[.25])}),q1s}function getBarsQ3(escapedBarsData){let q3s=[];return escapedBarsData.map(function(d){q3s.push(d.percentiles[.75])}),q3s}function getBarsMean(escapedBarsData){return escapedBarsData.map(function(d){return d.mean})}}}var isCurrentUserAdmin=!1,currentUserProducts=[],needToActivateListTab=!1,currentSelectedNodeId="";